"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.logout=exports.loginSuccess=exports.disableRaw=exports.enableRaw=exports.monitorOff=exports.monitorOn=exports.liveOff=exports.liveOn=exports.openGlobalLive=exports.getData=exports.stop=exports.start=exports.clearAll=exports.destroyScanner=exports.connect=exports.scan=exports.uploadSptData=exports.updateDeviceInfo=void 0;var _index=require("./index.js"),_index2=require("../../npm/@tarojs/taro-weapp/index.js"),_index3=_interopRequireDefault(_index2);function _interopRequireDefault(n){return n&&n.__esModule?n:{default:n}}var myPluginInterface=_index3.default.requirePlugin("myPlugin"),_myPluginInterface$bl=myPluginInterface.ble,MegaBleScanner=_myPluginInterface$bl.MegaBleScanner,MegaBleClient=_myPluginInterface$bl.MegaBleClient,APPID="ZURNaXgbXw",APPKEY="&e)CPKK?z;|p0V3";MegaBleClient.init(APPID,APPKEY);var scanner=null,client=null,populateDevicesfound=function(n){return{type:_index.constants.ACTION_DEVICES_FOUND,data:n}},updateToken=function(n){return{type:_index.constants.ACTION_UPDATE_TOKEN,data:n}},updateDeviceInfo=exports.updateDeviceInfo=function(n){return{type:_index.constants.ACTION_DEVICE_INFO,data:n}},uploadSptData=exports.uploadSptData=function(n){return{type:_index.constants.ACTION_UPLOAD_SPT_DATA,data:n}},scan=exports.scan=function(){return function(e){scanner?scanner.isScanning||(e(clearScannedDevices()),scanner.scan(),setTimeout(function(){scanner&&scanner.isScanning&&scanner.stopScan()},1e4)):(console.log("new a scanner."),e(clearScannedDevices()),(scanner=new MegaBleScanner(function(n){e(populateDevicesfound(n))})).initBleAdapter().then(function(){scanner.scan(),setTimeout(function(){scanner&&scanner.isScanning&&scanner.stopScan()},1e4)}).catch(function(n){return console.error(n)}))}},connect=exports.connect=function(o){return function(n){client=client||new MegaBleClient(genMegaCallback(n));var e=_index3.default.getStorageSync("token");client.connect(o.name,o.deviceId,o.advertisData).then(function(n){console.log(n),e&&-1!=e.indexOf(",")?client.startWithToken("5837288dc59e0d00577c5f9a",e).then(function(n){return console.log(n)}).catch(function(n){return console.error(n)}):client.startWithMasterToken().then(function(n){return console.log(n)}).catch(function(n){return console.error(n)})}).catch(function(n){return console.error(n)})}},clearScannedDevices=function(){return{type:_index.constants.ACTION_CLEAR}},destroyScanner=exports.destroyScanner=function(){return scanner&&(scanner.isScanning&&scanner.stopScan(),scanner=null),{type:_index.constants.ACTION_CLEAR}},clearAll=exports.clearAll=function(){client&&client.disconnect()},start=exports.start=function(){client.enableMonitorV1(!0)},stop=exports.stop=function(){client.enableMonitorV1(!1)},getData=exports.getData=function(){client.syncData()},openGlobalLive=exports.openGlobalLive=function(){client.toggleLive(!0)},liveOn=exports.liveOn=function(){client.enableV2ModeLiveSpo(!0)},liveOff=exports.liveOff=function(){client.enableV2ModeDaily(!0)},monitorOn=exports.monitorOn=function(){client.enableV2ModeSpoMonitor(!0)},monitorOff=exports.monitorOff=function(){client.enableV2ModeDaily(!0)},enableRaw=exports.enableRaw=function(){client.enableRawdata()},disableRaw=exports.disableRaw=function(){client.disableRawdata()},loginSuccess=exports.loginSuccess=function(e){return function(n){_index3.default.setStorage({key:"user",data:e}),e.sptToken&&_index3.default.setStorage({key:"token",data:e.sptToken}),n({type:_index.constants.ACTION_LOGIN_SUCCESS,data:e})}},logout=exports.logout=function(){return function(n){_index3.default.removeStorage({key:"user"}),_index3.default.removeStorage({key:"token"}),n({type:_index.constants.ACTION_LOGOUT})}},genMegaCallback=function(t){return{onAdapterStateChange:function(n){console.log("ble adapter state change: ",n),n.available&&console.log("ble available")},onConnectionStateChange:function(n){console.log("connection change: ",n),n.connected||t(updateDeviceInfo(null))},onBatteryChanged:function(n,e){console.log("onBatteryChanged: ",n,e)},onTokenReceived:function(n){console.log("onTokenReceived: ",n),_index3.default.setStorageSync("token",n),t(updateToken(n))},onKnockDevice:function(){console.log("onKnockDevice"),_index3.default.showLoading({title:"shake target device",mask:!0})},onOperationStatus:function(n,e){0!==e&&console.error("onOperationStatus: "+n.toString(16)+" - "+e.toString(16))},onEnsureBindWhenTokenNotMatch:function(){},onError:function(n){console.log("onError: ",n)},onCrashLogReceived:function(n){},onSyncingDataProgress:function(n){console.log("onSyncingDataProgress... "+n),_index3.default.showLoading({title:n+"%"})},onSyncMonitorDataComplete:function(n,e,o){console.log("onSyncMonitorDataComplete: ",n,e,o),t(uploadSptData(n))},onSyncDailyDataComplete:function(n){console.log("onSyncDailyDataComplete: ",n)},onSyncNoDataOfMonitor:function(){console.log("onSyncNoDataOfMonitor"),_index3.default.hideLoading()},onSyncNoDataOfDaily:function(){console.log("onSyncNoDataOfDaily")},onV2BootupTimeReceived:function(n){},onBatteryChangedV2:function(n,e,o){console.log("onBatteryChangedV2:",n,e,o)},onHeartBeatReceived:function(n){console.log("onHeartBeatReceived: ",n)},onV2PeriodSettingReceived:function(n){},onV2PeriodEnsureResponsed:function(n){},onV2PeriodReadyWarning:function(n){},onLiveDataReceived:function(n){console.log("onLiveDataReceived: ",n)},onV2LiveSleep:function(n){console.log("onV2LiveSleep: ",n)},onV2LiveSport:function(n){console.log("onV2LiveSport: ",n)},onV2LiveSpoMonitor:function(n){console.log("onV2LiveSpoMonitor: ",n)},onSetUserInfo:function(){client.setUserInfo(25,1,170,60,0)},onIdle:function(){console.log("idle"),_index3.default.hideLoading(),_index3.default.navigateBack()},onDeviceInfoUpdated:function(n){t(updateDeviceInfo(n))},onRawdataCount:function(n,e,o){},onDfuProgress:function(n){}}};