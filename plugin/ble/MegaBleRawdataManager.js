"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function s(t,e){for(var a=0;a<e.length;a++){var s=e[a];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t}}(),_MegaRequest=require("./MegaRequest.js"),_MegaRequest2=_interopRequireDefault(_MegaRequest),_MegaPako=require("./MegaPako.js"),_MegaPako2=_interopRequireDefault(_MegaPako),_MegaBleConst=require("./MegaBleConst.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var UPLOAD_INTERVAL=10,MegaBleRawdataManager=function(){function t(){_classCallCheck(this,t),this.cnt=0,this.totalList=[],this.isFirstPayload=!0,this.firstPayload=null,this.currentPayload=null,this.startTime=Date.now(),this.isProcessing=!1,this.taskTimeout=null,this.requestTask=null}return _createClass(t,[{key:"queue",value:function(t){this.isFirstPayload&&(this.isFirstPayload=!1,this.firstPayload=t),this.totalList.push(t),this.cnt++,this.currentPayload=t,this.isProcessing||this.processTask()}},{key:"clear",value:function(){this.taskTimeout&&clearTimeout(this.taskTimeout),this.requestTask&&this.requestTask.abort()}},{key:"getCount",value:function(){return this.cnt}},{key:"getDuration",value:function(){return Math.floor((Date.now()-this.startTime)/1e3)}},{key:"getBleCount",value:function(){if(!this.firstPayload||!this.currentPayload)return-1;if(this.firstPayload.length<20)return-1;var t=this.firstPayload[16]<<24|this.firstPayload[17]<<16|this.firstPayload[18]<<8|this.firstPayload[19];return(this.currentPayload[16]<<24|this.currentPayload[17]<<16|this.currentPayload[18]<<8|this.currentPayload[19])-t}},{key:"processTask",value:function(){if(!this.isProcessing){var t=this.totalList.length;t<=1||(console.log("processTask..."+~~(Date.now()/1e3)),this.isProcessing=!0,this.requestTask=_MegaRequest2.default.post("/rawdata",{rawdata:2===t?"start":_MegaPako2.default.deflate(this.totalList.slice(0,t).reduce(function(t,e){return t.concat(e)}),{to:"string"}),appId:_MegaBleConst.Config.AppId,appKey:_MegaBleConst.Config.AppKey,timestamp:~~(Date.now()/1e3)},null,function(t){return console.error(t)},this._doAfterRequest(2===t?0:t)))}}},{key:"_completeTask",value:function(){this.isProcessing=!1,this.processTask()}},{key:"_doAfterRequest",value:function(t){var e=this;this.totalList.splice(0,t),this.taskTimeout=setTimeout(function(){e._completeTask()},1e4)}}]),t}();exports.default=MegaBleRawdataManager;