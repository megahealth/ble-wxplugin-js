"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,a){for(var t=0;t<a.length;t++){var n=a[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,a,t){return a&&n(e.prototype,a),t&&n(e,t),e}}(),_MegaBleConst=require("./MegaBleConst.js"),_MegaBleBigDataManager=require("./MegaBleBigDataManager.js"),_MegaBleBigDataManager2=_interopRequireDefault(_MegaBleBigDataManager),_MegaUtils=require("./MegaUtils.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}var STEP_BIND_OK=1,STEP_READ_DEVICE_INFO=2,STEP_SET_TIME=3,STEP_SET_USERINFO=4,STEP_IDLE=5,PERIOD_HEART_BEAT=15,PERIOD_READ_RSSI=9,genStepList=function(){return[{sn:STEP_BIND_OK},{sn:STEP_READ_DEVICE_INFO},{sn:STEP_SET_TIME},{sn:STEP_SET_USERINFO},{sn:STEP_IDLE}]},MegaBleResponseManager=function(){function t(e,a){_classCallCheck(this,t),this.api=e,this.callback=a,this.loopManager=null,this.bigDataManager=null,this.stepList=genStepList()}return _createClass(t,[{key:"handleIndicateResponse",value:function(e){console.log("onIndicate <- "+(0,_MegaUtils.u8s2hex)(e));var a=e[0],t=e[2];switch(this.callback.onOperationStatus(a,t),a){case _MegaBleConst.CMD.FAKEBIND:0===t&&this._handleBind(e);break;case _MegaBleConst.CMD.SETTIME:if(0===t){var n=e[3]<<24|e[4]<<16|e[5]<<8|e[6];console.log("setTime respond time: "+n)}this._next();break;case _MegaBleConst.CMD.SETUSERINFO:this._next();break;case _MegaBleConst.CMD.LIVECTRL:case _MegaBleConst.CMD.MONITOR:case _MegaBleConst.CMD.FINDME:this.callback.onOperationStatus(a,t);break;case _MegaBleConst.CMD.CRASHLOG:this.callback.onCrashLogReceived(e);break;case _MegaBleConst.CMD.V2_GET_MODE:if(0===t){var s=1==e[3]||2==e[3]?e[4]<<24|e[5]<<16|e[6]<<8|e[7]:0;this.callback.onV2ModeReceived({mode:e[3],duration:s})}break;case _MegaBleConst.CMD.SYNCDATA:this._handleSyncData(a,t,e);break;case _MegaBleConst.CMD.CTRL_MONITOR_DATA:case _MegaBleConst.CMD.CTRL_MONITOR_DATA:this.bigDataManager&&this.bigDataManager.handleCtrlIndicate(e);break;case _MegaBleConst.CMD.V2_MODE_ECG_BP:case _MegaBleConst.CMD.V2_MODE_SPORT:case _MegaBleConst.CMD.V2_MODE_DAILY:case _MegaBleConst.CMD.V2_MODE_LIVE_SPO:this.callback.onOperationStatus(a,t);break;case _MegaBleConst.CMD.V2_GET_BOOTUP_TIME:if(0==t){var o=e[3]<<24|e[4]<<16|e[5]<<8|e[6];console.log("device bootup time: "+o),this.callback.onV2BootupTimeReceived(o)}break;case _MegaBleConst.CMD.NOTIBATT:0==t&&7<=e.length&&this.callback.onBatteryChangedV2(e[3],e[4],e[5]<<16|e[6]<<8|e[7]);break;case _MegaBleConst.CMD.HEARTBEAT:this.callback.onHeartBeatReceived({version:e[3],battPercent:e[4],deviceStatus:e[5],mode:e[6],recordStatus:e[7],periodMonitorStatus:e[8]});break;case _MegaBleConst.CMD.V2_PERIOD_MONITOR_SET:this.callback.onOperationStatus(a,t);break;case _MegaBleConst.CMD.V2_GET_PERIOD_SETTING:if(this.callback.onOperationStatus(a,t),0==t){var i=(0,_MegaUtils.byte4ToInt)([bytes[9],bytes[10],bytes[11],bytes[12]]);this.callback.onV2PeriodSettingReceived({status:e[3],periodType:e[4],h:e[5],m:e[6],s:e[7],maxTime:i})}break;case _MegaBleConst.CMD.V2_PERIOD_MONITOR_ENSURE:this.callback.onOperationStatus(a,t),0==t&&this.callback.onV2PeriodEnsureResponsed(e);break;case _MegaBleConst.CMD.V2_PERIOD_MONITOR_INDIC:this.callback.onV2PeriodReadyWarning(e)}}},{key:"handleNotifyResponse",value:function(e){switch(e[0]){case _MegaBleConst.CMD.LIVECTRL:console.log("notify comes [live]: "+(0,_MegaUtils.u8s2hex)(e)),this._dispatchV2Live(this.callback,e);break;case _MegaBleConst.CMD.NOTIBATT:this.callback.onBatteryChanged(e[3],e[4]);break;default:this.bigDataManager&&this.bigDataManager.handleNotify(e)}}},{key:"handleReadResponse",value:function(e){console.log("onRead: "+(0,_MegaUtils.u8s2hex)(e));var a=(0,_MegaUtils.parseRead)(e);console.log(a),this.callback.onDeviceInfoUpdated(a),this._next()}},{key:"handleDisconnect",value:function(){this.loopManager&&(this.loopManager.clearLoop(),this.loopManager=null)}},{key:"_next",value:function(){var e=this;if(0!==this.stepList.length)switch(this.stepList.shift().sn){case STEP_BIND_OK:this.loopManager=new LoopManager({onSendHeartBeat:function(){return e.api.sendHeartBeat()}}),this._next();break;case STEP_READ_DEVICE_INFO:this.api.readDeviceInfo();break;case STEP_SET_TIME:this.api.setTime();break;case STEP_SET_USERINFO:this.callback.onSetUserInfo();break;case STEP_IDLE:this.callback.onIdle()}}},{key:"_handleSyncData",value:function(e,a,t){var n=this;this.callback.onOperationStatus(e,a),0===a?(console.log("Trans permission [yes]..."),this.bigDataManager=new _MegaBleBigDataManager2.default({writeReportPack:function(e){n.api.writeReportPack(e)},onProgress:function(e){n.callback.onSyncingDataProgress(e)},onMonitorDataComplete:function(e,a,t){n.callback.onSyncMonitorDataComplete(e,a,t)},onDailyDataComplete:function(e){n.callback.onSyncDailyDataComplete(e)},syncMonitorData:function(){return n.api.syncMonitorData()},syncDailyData:function(){return n.api.syncDailyData()}}),this.bigDataManager.handleTransmitPermited(t)):(this.bigDataManager=null,2===a&&(console.log("Trans permission [no], no data."),0===t[5]||t[5]===_MegaBleConst.CMD.CTRL_DAILY_DATA?this.callback.onSyncNoDataOfDaily():t[5]==_MegaBleConst.CMD.CTRL_MONITOR_DATA&&this.callback.onSyncNoDataOfMonitor()))}},{key:"_handleBind",value:function(e){switch(e[3]){case 0:this.callback.onTokenReceived([e[4],e[5],e[6],e[7],e[8],e[9]].join(",")),this._next();break;case 1:this._next();break;case 2:this.callback.onKnockDevice();break;case 3:this.callback.onOperationStatus(e[0],_MegaBleConst.STATUS.STATUS_LOWPOWER);break;case 4:this.callback.onEnsureBindWhenTokenNotMatch();break;default:this.callback.onError(_MegaBleConst.STATUS.ERROR_BIND)}}},{key:"_dispatchV2Live",value:function(e,a){if(e)switch(a[2]){case 0:e.onLiveDataReceived({spo:a[3],hr:a[4],status:a[5]});break;case 1:e.onV2LiveSleep({status:a[3],spo:a[4],pr:a[5],duration:a[6]<<24|a[7]<<16|a[8]<<8|a[9]});break;case 2:e.onV2LiveSport({status:a[3],pr:a[4],duration:a[5]<<24|a[6]<<16|a[7]<<8|a[8]});break;case 3:break;case 4:e.onV2LiveSpoMonitor({status:a[3],spo:a[4],pr:a[5]})}}}]),t}(),LoopManager=function(){function a(e){_classCallCheck(this,a),this.loopCallback=e,this.loopArr=[],this.startLoop()}return _createClass(a,[{key:"startLoop",value:function(){var e=this;if(0==this.loopArr.length){var a=setInterval(function(){e.loopCallback.onSendHeartBeat()},15e3);this.loopArr.push(a)}}},{key:"clearLoop",value:function(){this.loopArr.forEach(function(e){return clearInterval(e)}),this.loopArr.length=0}}]),a}();exports.default=MegaBleResponseManager;