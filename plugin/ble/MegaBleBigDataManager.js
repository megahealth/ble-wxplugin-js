"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function s(t,e){for(var a=0;a<e.length;a++){var s=e[a];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t}}(),_MegaUtils=require("./MegaUtils.js"),_MegaBleConst=require("./MegaBleConst.js");function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var CRC_LEN=2,PAYLOAD_LEN=19,MegaBleBigDataManager=function(){function e(t){_classCallCheck(this,e),this.totalBytes=[],this.subSnMap={},this.totalLen=0,this.subLen=0,this.mReportPack=[],this.mReportPackMissPack=[],this.ver=[],this.stopType=0,this.dataType=0,this.iDataCallback=t}return _createClass(e,[{key:"handleTransmitPermited",value:function(t){this.ver=[t[3],t[6],0,0],this.stopType=t[4],this.dataType=t[6]}},{key:"handleCtrlIndicate",value:function(t){if(0==t[2])this.totalLen=t[3]<<24|t[4]<<16|t[5]<<8|t[6],this.subLen=t[7]<<8|t[8],console.log("Total length: "+this.totalLen+", sub length: "+this.subLen),this.subSnMap={},this.mReportPackMissPack=new Uint8Array(16);else if(1==t[2]){var e=Math.ceil((this.subLen+CRC_LEN)/PAYLOAD_LEN)-Object.keys(this.subSnMap).length;this.mReportPack=new Uint8Array(20),this.mReportPack[0]=t[0],this.mReportPack[1]=t[1],0==e?this.handleNoMiss(t):this.handleMiss(e)}}},{key:"handleNotify",value:function(t){if(this.mReportPackMissPack){var e=t[0];this.subSnMap.hasOwnProperty(e)||(this.subSnMap[e]=t.subarray(1),this.mReportPackMissPack[Math.floor(e/8)]|=1<<e%8)}else console.log("Big data receive warning: Notify comes ahead of indicate, app_report_pack_misspart has not been initiated")}},{key:"handleNoMiss",value:function(t){for(var e=this,a=Object.keys(this.subSnMap).length,s=[],i=0;i<a;i++)s=s.concat(Array.from(this.subSnMap[i]));s.splice(this.subLen+2);var o=s.splice(-2),n=o[1]|o[0]<<8,r=(0,_MegaUtils.crc16XModem)(s);if(console.log("blecrc: "+n+", mycrc: "+r),r===n){if(this.mReportPack[2]=1,this.iDataCallback.writeReportPack(this.mReportPack),this.totalBytes=this.totalBytes.concat(s),this.totalLen<=0)return;var l=Math.floor(100*this.totalBytes.length/this.totalLen);if(this.iDataCallback.onProgress(l),console.log("receiving data, progress "+l),0<this.totalLen&&this.totalLen==this.totalBytes.length){var c=this.ver.concat(this.totalBytes);if(t[0]==_MegaBleConst.CMD.CTRL_MONITOR_DATA)this.iDataCallback.onMonitorDataComplete(c,this.stopType,this.dataType),setTimeout(function(){return e.iDataCallback.syncMonitorData()},1200);else if(t[0]==_MegaBleConst.CMD.CTRL_DAILY_DATA){var h=(0,_MegaUtils.intToByte4)(Math.floor(Date.now()/1e3)).concat(c);this.iDataCallback.onDailyDataComplete(h),setTimeout(function(){return e.iDataCallback.syncDailyData()},1200)}}}else console.error("crc wrong!"),this.mReportPack[2]=0,this.mReportPack[3]=255,this.iDataCallback.writeReportPack(this.mReportPack)}},{key:"handleMiss",value:function(t){this.mReportPack[2]=0,this.mReportPack[3]=t,this.mReportPack.set(this.mReportPackMissPack,4),this.iDataCallback.writeReportPack(this.mReportPack)}}]),e}();exports.default=MegaBleBigDataManager;